service:
  name: kaskadi-stocks-api

plugins:
  - serverless-aws-documentation

custom:
  documentation:
    api:
      info:
        version: 0.0.1
        title: ${self:service.name}
        description: This API manages stocks for the Kaskadi project

provider:
  name: aws
  runtime: nodejs12.x
  stackName: ${self:service.name}-stack
  stage: ${opt:stage, 'prod'}
  region: eu-central-1
  deploymentBucket:
    name: kaskadi-serverless-deployment-bucket

resources:
  Resources:
    ApiGatewayRestApi:
      Type: AWS::ApiGateway::RestApi
      Properties:
        Name: ${self:service.name}
    AmzResource:
        Type: AWS::ApiGateway::Resource
        Properties:
            RestApiId: !Ref ApiGatewayRestApi
            ParentId: !GetAtt ApiGatewayRestApi.RootResourceId
            PathPart: "amz"
    YswsResource:
        Type: AWS::ApiGateway::Resource
        Properties:
            RestApiId: !Ref ApiGatewayRestApi
            ParentId: !GetAtt ApiGatewayRestApi.RootResourceId
            PathPart: "ysws"
    CognitoAuthorizer:
      DependsOn:
        - ApiGatewayRestApi
      Type: AWS::ApiGateway::Authorizer
      Properties:
        Name: cognito-authorizer
        IdentitySource: method.request.header.Authorization
        RestApiId:
          Ref: ApiGatewayRestApi
        Type: COGNITO_USER_POOLS
        ProviderARNs:
          - !ImportValue KaskadiCognitoUserPoolARN
          
  Outputs:
    RestAPIGatewayId:
      Value:
        Ref: ApiGatewayRestApi
      Export:
        Name: KaskadiStocksRestAPIGatewayId
    RestAPIGatewayRootResourceId:
      Value: !GetAtt ApiGatewayRestApi.RootResourceId
      Export:
        Name: KaskadiStocksRestAPIGatewayRootResourceId
    AmzResourceId:
      Value:
        Ref: AmzResource
      Export:
        Name: ${self:service.name}-amz-resource-id
    YswsResourceId:
      Value:
        Ref: YswsResource
      Export:
        Name: ${self:service.name}-ysws-resource-id
    CognitoAuthorizerId:
      Value:
        Ref: CognitoAuthorizer
      Export:
        Name: KaskadiStocksCognitoAuthorizerId
